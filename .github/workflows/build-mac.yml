name: Build macOS App

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller requests

    - name: Verify source file
      run: |
        if [ ! -f "delegate_gui_safe.py" ]; then
          echo "ERROR: delegate_gui_safe.py not found!"
          exit 1
        fi

    # КЛЮЧЕВОЙ ФИКС: НЕ используем --onefile
    - name: Build .app (directory mode)
      run: |
        pyinstaller \
          --windowed \
          --name "Yandex Delegate" \
          --distpath dist \
          --workpath build \
          delegate_gui_safe.py

        # Перемещаем в правильную структуру .app
        mkdir -p "dist/Yandex Delegate.app/Contents/MacOS"
        mkdir -p "dist/Yandex Delegate.app/Contents/Resources"

        # Копируем исполняемый файл
        cp "dist/Yandex Delegate" "dist/Yandex Delegate.app/Contents/MacOS/Yandex Delegate"

        # Создаём минимальный Info.plist
        cat > "dist/Yandex Delegate.app/Contents/Info.plist" << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>CFBundleExecutable</key>
    <string>Yandex Delegate</string>
    <key>CFBundleIdentifier</key>
    <string>com.yourcompany.yandexdelegate</string>
    <key>CFBundleName</key>
    <string>Yandex Delegate</string>
    <key>CFBundlePackageType</key>
    <string>APPL</string>
    <key>CFBundleShortVersionString</key>
    <string>1.0</string>
</dict>
</plist>
EOF

        echo "App bundle created"

    - name: Test executable
      run: |
        chmod +x "dist/Yandex Delegate.app/Contents/MacOS/Yandex Delegate"
        "dist/Yandex Delegate.app/Contents/MacOS/Yandex Delegate" --version || echo "No --version, but started"
        echo "Executable runs!"

    - name: Zip .app bundle
      run: |
        cd dist
        ditto -c -k --sequesterRsrc --keepParent "Yandex Delegate.app" ../Yandex-Delegate-macOS.zip

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: Yandex-Delegate-macOS
        path: Yandex-Delegate-macOS.zip

    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Build-Logs
        path: |
          build/
          *.spec
          *.log
