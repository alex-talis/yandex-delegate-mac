name: Build macOS App

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macOS-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller requests

    - name: Verify source file
      run: |
        if [ ! -f "delegate_gui_safe.py" ]; then
          echo "ERROR: delegate_gui_safe.py not found!"
          exit 1
        fi

    - name: Build .app (directory mode)
      run: |
        pyinstaller \
          --windowed \
          --name "Yandex Delegate" \
          --distpath dist \
          --workpath build \
          delegate_gui_safe.py

        APP_DIR="dist/Yandex Delegate.app"
        mkdir -p "$APP_DIR/Contents/MacOS"
        mkdir -p "$APP_DIR/Contents/Resources"

        cp "dist/Yandex Delegate" "$APP_DIR/Contents/MacOS/Yandex Delegate"

        # Создаём Info.plist через echo (без heredoc)
        cat > "$APP_DIR/Contents/Info.plist" << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>CFBundleExecutable</key>
    <string>Yandex Delegate</string>
    <key>CFBundleIdentifier</key>
    <string>com.yourcompany.yandexdelegate</string>
    <key>CFBundleName</key>
    <string>Yandex Delegate</string>
    <key>CFBundlePackageType</key>
    <string>APPL</string>
    <key>CFBundleShortVersionString</key>
    <string>1.0</string>
</dict>
</plist>
EOF

        echo "App bundle created at $APP_DIR"

    - name: Test executable
      run: |
        APP_DIR="dist/Yandex Delegate.app"
        chmod +x "$APP_DIR/Contents/MacOS/Yandex Delegate"
        timeout 5 "$APP_DIR/Contents/MacOS/Yandex Delegate" --help || echo "App started"

    - name: Zip .app bundle
      run: |
        cd dist
        ditto -c -k --sequesterRsrc --keepParent "Yandex Delegate.app" ../Yandex-Delegate-macOS.zip

    - name: Upload .app ZIP
      uses: actions/upload-artifact@v4
      with:
        name: Yandex-Delegate-macOS
        path: Yandex-Delegate-macOS.zip
        retention-days: 30

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Build-Logs
        path: |
          build/
          *.spec
          *.log
